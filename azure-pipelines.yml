strategy:
  matrix:
    # Windows2019:
    #   Pool: 'azsdk-pool-mms-win-2019-general'
    #   OsVmImage: 'MMS2019'
    Windows2022:
      Pool: 'Azure Pipelines'
      OsVmImage: 'windows-2022'

pool:
  name: $(Pool)
  vmImage: $(OSVmImage)

variables:
  skipComponentGovernanceDetection: true
  NugetSecurityAnalysisWarningLevel: 'none'

steps:
  - script: wsl --install -d Ubuntu-20.04
    displayName: wsl --install -d Ubuntu-20.04
    condition: succeededOrFailed()

  - pwsh: |
      # wsl output is UTF-16, so the console encoding must be changed to correctly capture the output
      [console]::OutputEncoding = New-Object System.Text.UnicodeEncoding

      $wsl = wsl -l -v | out-string
      write-host $wsl

      while ($wsl -match 'installing') {
          start-sleep -seconds 1
          $wsl = wsl -l -v | out-string
          write-host $wsl
      }
    displayName: Wait until distro is running
    condition: succeededOrFailed()

  - script: wsl sudo apt-get -y install squid net-tools
    displayName: wsl sudo apt install squid net-tools
    condition: succeededOrFailed()

  - script: wsl sudo squid
    displayName: wsl sudo squid
    condition: succeededOrFailed()

  - script: wsl cp /etc/squid/squid.conf /tmp/squid.conf; sed -i 's\http_port 3128\http_port 3129\' /tmp/squid.conf; sed -i 's\# pid_filename /var/run/squid.pid\pid_filename /var/run/squid2.pid\' /tmp/squid.conf;
    displayName: Create /tmp/squid.conf

  - script: wsl sudo squid -f /tmp/squid.conf
    displayName: wsl sudo squid -f /tmp/squid.conf
    condition: succeededOrFailed()

  - script: wsl ps auxf
    displayName: wsl ps axuf
    condition: succeededOrFailed()

  - script: wsl netstat -an
    displayName: wsl netstat -an
    condition: succeededOrFailed()

  - script: curl -v http://www.example.org
    displayName: curl -v http://www.example.org
    condition: succeededOrFailed()

  - script: curl -x http://localhost:3128 -v http://www.example.org
    displayName: curl -x http://localhost:3128 -v http://www.example.org
    condition: succeededOrFailed()

  - script: curl -x http://localhost:3129 -v http://www.example.org
    displayName: curl -x http://localhost:3129 -v http://www.example.org
    condition: succeededOrFailed()
